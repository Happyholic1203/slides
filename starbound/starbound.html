<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <title></title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="reveal.js/css/reveal.min.css"/>
    <style type="text/css">code{white-space: pre;}</style>
    <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
    </style>
    <link rel="stylesheet" href="reveal.js/css/theme/simple.css" id="theme">
    <!-- If the query includes 'print-pdf', include the PDF print sheet -->
    <script>
      if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
      }
    </script>
    <!--[if lt IE 9]>
    <script src="reveal.js/lib/js/html5shiv.js"></script>
    <![endif]-->
</head>
<body>
  <div class="reveal">
    <div class="slides">


<section><section id="starbound" class="titleslide slide level1"><h1>Starbound</h1></section><section id="a-game" class="slide level2">
<h1>A Game</h1>
<pre><code> / Pos: 365 HP: 100                              \ 
|                                                 |
|                                                 |
|        ,~                                       |
|       /..\             o                        |
|       ....             T                        |
|       ....             ,~                       |
|      /....`_~         /..                       |
|    ,-........         ...\       ,__~           |
|   /..........\       /#...    ,_-....\          |
|   .....#......      /.....   /........    ,_~   |
|  /...........#    ,-......`_-#...#....`__-...\  |
| /.#...........    ........................#...  |
|-..............\  /............................`_|
|#...........#...`-..............#...........#....|
|..............#...............................#..|
|...............#.......@...........#.............|
|.........@.......................#...........#...|
 \_______________________________________________/
</code></pre>
</section><section id="the-menu" class="slide level2">
<h1>The Menu</h1>
<pre><code>-+STARBOUND v1.0+-
  0. Exit
  1. Info
  2. Move
  3. View
  4. Tools
  5. Kill
  6. Settings
  7. Multiplayer
&gt; </code></pre>
</section></section>
<section><section id="analysis" class="titleslide slide level1"><h1>Analysis</h1></section><section id="overview" class="slide level2">
<h1>Overview</h1>
<pre class="sourceCode c"><code class="sourceCode c"><span class="dt">int</span> __cdecl main()
{
  __int32 v0; <span class="co">// eax@3</span>
  <span class="dt">int</span> v2; <span class="co">// [sp+10h] [bp-104h]@2</span>

  init();
  <span class="kw">while</span> ( <span class="dv">1</span> )
  {
    alarm(0x3Cu);
    (*(<span class="dt">void</span> (**)(<span class="dt">void</span>))&amp;me[<span class="dv">508</span>])();
    <span class="kw">if</span> ( !readn(&amp;v2, <span class="dv">256</span>) )
      <span class="kw">break</span>;
    v0 = strtol((<span class="dt">const</span> <span class="dt">char</span> *)&amp;v2, <span class="dv">0</span>, <span class="dv">10</span>);
    <span class="kw">if</span> ( !v0 )
      <span class="kw">break</span>;
    (*(<span class="dt">void</span> (**)(<span class="dt">void</span>))&amp;me[<span class="dv">4</span> * v0 + <span class="dv">468</span>])();
  }
  do_bye();
  <span class="kw">return</span> <span class="dv">0</span>;
}</code></pre>
</section><section id="the-flag" class="slide level2">
<h1>The flag</h1>
<pre class="sourceCode c"><code class="sourceCode c"><span class="dt">int</span> __cdecl get_server_key(<span class="dt">int</span> a1)
{
  <span class="dt">int</span> v1; <span class="co">// esi@1</span>
  <span class="dt">signed</span> <span class="dt">int</span> i; <span class="co">// ebx@1</span>
  <span class="dt">char</span> v4; <span class="co">// [sp+14h] [bp-268h]@4</span>
  <span class="dt">char</span> v5[<span class="dv">524</span>]; <span class="co">// [sp+70h] [bp-20Ch]@1</span>

  memset(v5, <span class="dv">0</span>, 0x200u);
  v1 = open(<span class="st">&quot;/home/flags/starbound&quot;</span>, <span class="dv">0</span>);
  <span class="kw">for</span> ( i = <span class="dv">0</span>; i &lt;= <span class="dv">511</span>; i += <span class="dv">32</span> )
  {
    read(v1, &amp;v5[i], 0x20u);
    lseek(v1, <span class="dv">0</span>, <span class="dv">0</span>);
  }
  memfrob(v5, <span class="dv">512</span>);
  MD5_Init(&amp;v4);
  MD5_Update(&amp;v4, v5, <span class="dv">512</span>);
  <span class="kw">return</span> MD5_Final(a1, &amp;v4);
}</code></pre>
</section><section id="remarks" class="slide level2">
<h1>Remarks</h1>
<ul>
<li><code>me</code> is a big global buffer</li>
<li><code>readn(&amp;v2, 100u)</code>: stack overflow?</li>
<li><code>get_server_flag</code></li>
</ul>
</section></section>
<section><section id="the-plan" class="titleslide slide level1"><h1>The Plan</h1></section><section id="steps" class="slide level2">
<h1>Steps</h1>
<ul>
<li><a href="#/step1-hijack-the-control-flow-1">Hijack the control flow</a></li>
<li><a href="#/step2-read-the-flag">Read the flag onto <code>me</code></a></li>
<li><a href="#/step3-dump-the-flag">Dump the flag using <code>cmd_info</code></a></li>
</ul>
</section><section id="step1-hijack-the-control-flow-1" class="slide level2">
<h1>Step1: Hijack the Control Flow (1)</h1>
<pre><code>-+STARBOUND v1.0+-
  0. Exit
  1. Info
  2. Move
  3. View
  4. Tools
  5. Kill
  6. Settings
  7. Multiplayer
&gt; 6

-+STARBOUND v1.0: SETTINGS+-
  0. Exit
  1. Back
  2. Name
  3. IP
  4. Toggle View
&gt; 2 AAAAA... &lt;&lt;&lt;&lt;&lt;&lt;&lt; put rop code onto the stack
Enter your name:  &lt;&lt;&lt;&lt;&lt;&lt;&lt; overflow to hijack control flow</code></pre>
</section><section id="step1-hijack-the-control-flow-2" class="slide level2">
<h1>Step1: Hijack the Control Flow (2)</h1>
<pre><code>.bss
0x08057F80      me (char[512])
...
0x080580C8      host
...
0x080580D0      player name (me[336]) &lt;&lt;&lt;&lt;&lt;&lt; overflow (0x100)
...             (cmds)
0x08058178
0x0805817c      (me[508])  &lt;&lt;&lt;&lt;&lt;&lt; hijack (executes in loop)
0x08058180      end of me</code></pre>
</section><section id="step1-hijack-the-control-flow-3" class="slide level2">
<h1>Step1: Hijack the Control Flow (3)</h1>
<pre class="sourceCode c"><code class="sourceCode c"><span class="dt">int</span> __cdecl main()
{
  __int32 v0; <span class="co">// eax@3</span>
  <span class="dt">int</span> v2; <span class="co">// [sp+10h] [bp-104h]@2</span>

  init();
  <span class="kw">while</span> ( <span class="dv">1</span> )
  {
    alarm(0x3Cu);
    (*(<span class="dt">void</span> (**)(<span class="dt">void</span>))&amp;me[<span class="dv">508</span>])(); <span class="co">// &lt;&lt;&lt;&lt;&lt;&lt; Hijack</span>
    <span class="kw">if</span> ( !readn(&amp;v2, <span class="dv">256</span>) ) <span class="co">// &lt;&lt;&lt;&lt;&lt;&lt;&lt; Overflow</span>
      <span class="kw">break</span>;
    v0 = strtol((<span class="dt">const</span> <span class="dt">char</span> *)&amp;v2, <span class="dv">0</span>, <span class="dv">10</span>);
    <span class="kw">if</span> ( !v0 )
      <span class="kw">break</span>;
    (*(<span class="dt">void</span> (**)(<span class="dt">void</span>))&amp;me[<span class="dv">4</span> * v0 + <span class="dv">468</span>])();
  }
  do_bye();
  <span class="kw">return</span> <span class="dv">0</span>;
}</code></pre>
</section><section id="step2-read-the-flag-1" class="slide level2">
<h1>Step2: Read the flag (1)</h1>
<pre><code>-+STARBOUND v1.0: SETTINGS+-
  0. Exit
  1. Back
  2. Name
  3. IP
  4. Toggle View
&gt; 2 AAAAA... &lt;&lt;&lt;&lt;&lt;&lt;&lt; *put rop code onto the stack*
Enter your name:  &lt;&lt;&lt;&lt;&lt;&lt;&lt; overflow to hijack control flow</code></pre>
</section><section id="step2-read-the-flag" class="slide level2">
<h1>Step2: Read the flag</h1>
<pre><code>ROP stack:
+------------------+
|                  |
+------------------+</code></pre>
</section><section id="step3-dump-the-flag" class="slide level2">
<h1>Step3: Dump the flag</h1>
<pre class="sourceCode c"><code class="sourceCode c"><span class="co">// cmd_info</span>
__printf_chk(
    <span class="dv">1</span>, 
    <span class="st">&quot; +  Player: %s (from %s)</span><span class="ch">\n</span><span class="st">&quot;</span>,
    <span class="dv">134578384</span>, <span class="co">// 0x80580d0: me[336] &lt;- player name</span>
    *(_DWORD *)&amp;me[<span class="dv">328</span>]);</code></pre>
</section></section>
    </div>
  </div>


  <script src="reveal.js/lib/js/head.min.js"></script>
  <script src="reveal.js/js/reveal.min.js"></script>

  <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,
        theme: 'henry', // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } },
//          { src: 'reveal.js/plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; }, }
//          { src: 'reveal.js/plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
]});
    </script>
    </body>
</html>
